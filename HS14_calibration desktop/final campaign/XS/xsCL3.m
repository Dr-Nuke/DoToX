%%% lets re do the att coeff calculation



%% speccalc data
    
    % **** COMMENT ****
    %
    % **** INPUTS ****
    % kVp [kV] hvMIN [keV] Dhv [keV]
    % 110  11  1
    % Angle [deg.]
    % 12
    % t_AIR t_BE t_AL t_CU t_SN t_W t_Wa [mm]
    % 1000  0  3.4  0.2  0  0  0
    % Nf P
    % 0.68  0.33
    % ****CALCULATED OUTPUTS ****
    % Brem[uGy/mAs@1m] Char[uGy/mAs@1m]
    % 37.77275  4.150026
    % HVL1[cm AL] HVL2[cm AL] HVL1[cmCu] HVL2[cmCu] MeanE[keV] EffEAl[keV] EffECu[keV]
    % 0.7530923  0.9011965  0.0377079  0.0587936  61.55855  52.37369  54.62214
    % **** CALCULATED SPECTRUM ****
    % Energy[keV]  N[keV cm^2 mAs]^-1 @ 1 meter
    
    spec= [11 , 4.235940e-15;
        12 , 1.056486e-10 ;
        13 , 2.567868e-7  ;
        14 , 0.0000852    ;
        15 , 0.0074988    ;
        16 , 0.2509247    ;
        17 , 3.885374     ;
        18 , 34.772       ;
        19 , 206.5956     ;
        20 , 886.4131     ;
        21 , 2924.845     ;
        22 , 7997.122     ;
        23 , 18415.28     ;
        24 , 37476.11     ;
        25 , 67421.13     ;
        26 , 112373.8     ;
        27 , 171939.6     ;
        28 , 252642       ;
        29 , 344636.6     ;
        30 , 451831.1     ;
        31 , 570758.7     ;
        32 , 700179       ;
        33 , 835063.7     ;
        34 , 974990.4     ;
        35 , 1.112241e+6  ;
        36 , 1.246623e+6  ;
        37 , 1.375792e+6  ;
        38 , 1.500727e+6  ;
        39 , 1.613081e+6  ;
        40 , 1.720311e+6  ;
        41 , 1.815014e+6  ;
        42 , 1.902275e+6  ;
        43 , 1.977505e+6  ;
        44 , 2.045455e+6  ;
        45 , 2.098338e+6  ;
        46 , 2.146997e+6  ;
        47 , 2.184832e+6  ;
        48 , 2.214508e+6  ;
        49 , 2.237069e+6  ;
        50 , 2.250773e+6  ;
        51 , 2.259073e+6  ;
        52 , 2.256035e+6  ;
        53 , 2.253790e+6  ;
        54 , 2.244392e+6  ;
        55 , 2.233469e+6  ;
        56 , 2.212175e+6  ;
        57 , 2.190791e+6  ;
        58 , 6.109498e+6  ;
        59 , 9.108508e+6  ;
        60 , 2.110834e+6  ;
        61 , 2.078199e+6  ;
        62 , 2.043164e+6  ;
        63 , 2.005841e+6  ;
        64 , 1.971676e+6  ;
        65 , 1.929713e+6  ;
        66 , 1.891193e+6  ;
        67 , 4.386712e+6  ;
        68 , 1.808032e+6  ;
        69 , 2.442177e+6  ;
        70 , 1.522234e+6  ;
        71 , 1.490227e+6  ;
        72 , 1.459920e+6  ;
        73 , 1.429941e+6  ;
        74 , 1.397765e+6  ;
        75 , 1.366144e+6  ;
        76 , 1.331933e+6  ;
        77 , 1.298882e+6  ;
        78 , 1.265607e+6  ;
        79 , 1.231013e+6  ;
        80 , 1.196406e+6  ;
        81 , 1.161623e+6  ;
        82 , 1.127735e+6  ;
        83 , 1.092687e+6  ;
        84 , 1.056985e+6  ;
        85 , 1.021636e+6  ;
        86 , 987102.2     ;
        87 , 951791.1     ;
        88 , 917056.8     ;
        89 , 881159.1     ;
        90 , 846482.2     ;
        91 , 810705.8     ;
        92 , 775893.3     ;
        93 , 740281.6     ;
        94 , 704619.7     ;
        95 , 669828.8     ;
        96 , 633688.3     ;
        97 , 598350.6     ;
        98 , 561787.3     ;
        99 , 526209       ;
        100,  489580.9    ;
        101,  453083.4    ;
        102,  415478.2    ;
        103,  377931.4    ;
        104,  338111.9    ;
        105,  296507.4    ;
        106,  255760.7    ;
        107,  214721.3    ;
        108,  166169.4    ;
        109,  81787.88    ;
        110,  0           ];
    
    spec(:,1) =spec(:,1)*1000; % keV to eV


%% the attenuation coefficient goes here in 1/cm

    %  from https://physics.nist.gov/cgi-bin/Xcom/xcom3_1 CHCL3
% with coherent scattering in cm2/g
    
cl3=[1.000E-03, 2.745E+03; 
1.100E-03, 2.134E+03; 
1.200E-03, 1.696E+03; 
1.300E-03, 1.373E+03; 
1.400E-03, 1.129E+03; 
1.500E-03, 9.411E+02; 
1.600E-03, 7.907E+02; 
1.700E-03, 6.714E+02; 
1.800E-03, 5.755E+02; 
1.900E-03, 4.974E+02; 
2.000E-03, 4.332E+02; 
2.100E-03, 3.790E+02; 
2.300E-03, 2.956E+02; 
2.400E-03, 2.631E+02; 
2.600E-03, 2.114E+02; 
2.700E-03, 1.908E+02; 
2.900E-03, 1.404E+03; 
3.100E-03, 1.236E+03; 
3.300E-03, 1.068E+03; 
3.500E-03, 9.158E+02; 
3.700E-03, 7.849E+02; 
4.000E-03, 6.308E+02; 
4.200E-03, 5.525E+02; 
4.500E-03, 4.604E+02; 
4.800E-03, 3.890E+02; 
5.100E-03, 3.316E+02; 
5.400E-03, 2.845E+02; 
5.800E-03, 2.343E+02; 
6.200E-03, 1.951E+02; 
6.600E-03, 1.643E+02; 
7.000E-03, 1.396E+02; 
7.500E-03, 1.153E+02; 
7.900E-03, 9.969E+01; 
8.500E-03, 8.118E+01; 
9.000E-03, 6.910E+01; 
9.600E-03, 5.756E+01; 
1.020E-02, 4.844E+01; 
1.090E-02, 4.008E+01; 
1.160E-02, 3.354E+01; 
1.230E-02, 2.834E+01; 
1.310E-02, 2.364E+01; 
1.400E-02, 1.951E+01; 
1.490E-02, 1.629E+01; 
1.580E-02, 1.375E+01; 
1.690E-02, 1.131E+01; 
1.800E-02, 9.421E+00; 
1.910E-02, 7.934E+00; 
2.040E-02, 6.558E+00; 
2.170E-02, 5.487E+00; 
2.310E-02, 4.584E+00; 
2.460E-02, 3.829E+00; 
2.620E-02, 3.201E+00; 
2.790E-02, 2.681E+00; 
2.970E-02, 2.252E+00; 
3.160E-02, 1.898E+00; 
3.360E-02, 1.607E+00; 
3.580E-02, 1.357E+00; 
3.810E-02, 1.153E+00; 
4.060E-02, 9.812E-01; 
4.320E-02, 8.418E-01; 
4.600E-02, 7.247E-01; 
4.900E-02, 6.269E-01; 
5.220E-02, 5.456E-01; 
5.560E-02, 4.783E-01; 
5.920E-02, 4.226E-01; 
6.300E-02, 3.765E-01; 
6.710E-02, 3.375E-01; 
7.140E-02, 3.053E-01; 
7.610E-02, 2.776E-01; 
8.100E-02, 2.548E-01; 
8.620E-02, 2.355E-01; 
9.180E-02, 2.190E-01; 
9.780E-02, 2.048E-01; 
1.041E-01, 1.929E-01; 
1.108E-01, 1.825E-01; 
1.180E-01, 1.735E-01; 
1.257E-01, 1.655E-01; 
1.338E-01, 1.586E-01; 
1.425E-01, 1.523E-01; 
1.517E-01, 1.467E-01; 
1.615E-01, 1.417E-01; 
1.720E-01, 1.370E-01; 
1.831E-01, 1.327E-01; 
1.950E-01, 1.287E-01; 
2.076E-01, 1.250E-01; 
2.211E-01, 1.215E-01; 
2.354E-01, 1.181E-01; 
2.507E-01, 1.149E-01; 
2.669E-01, 1.118E-01; 
2.842E-01, 1.089E-01; 
3.026E-01, 1.060E-01; 
3.222E-01, 1.032E-01; 
3.431E-01, 1.005E-01; 
3.653E-01, 9.786E-02; 
3.890E-01, 9.529E-02; 
4.142E-01, 9.277E-02; 
4.410E-01, 9.031E-02; 
4.696E-01, 8.790E-02; 
5.000E-01, 8.554E-02];

cl3(:,1)=cl3(:,1)*1000000; % MeV to eV
cl3(:,2)=cl3(:,2)*1.411; % from cm2/g to 1/cm,; multiply with density

%% data overview plot

figure(1);clf;
subplot(2,2,1)
loglog(spec(:,1),spec(:,2))
title('110 kV spectrum, log')
grid on
xlim([2e3,5e5])
xticks([1e3 1e4 1e5])
ylim([1e2,1e8])
xlabel('eV')
ylabel('[-]')

subplot(2,2,2)
plot(spec(:,1),spec(:,2))
title('110 kV spectrum, lin')
grid on
xlim(1e3*[20,110])
xlabel('eV')
ylabel('[-]')

subplot(2,2,3)
loglog(cl3(:,1),cl3(:,2))
title('chloroform 1/cm,log')
grid on
xlim([2e3,5e5])
xticks([1e3 1e4 1e5])
ylim([1e-1 1e4])
xlabel('eV')
ylabel('cm^{-1}')

subplot(2,2,4)
plot(cl3(:,1),cl3(:,2))
title('chloroform 1/cm, lin')
xlim(1e3*[20,110])
ylim([0 3])
grid on
xlabel('eV')
ylabel('cm^{-1}')

%% another validation plot
figure(2);clf;


plot(cl3(:,1),cl3(:,2));
hold on
plot(spec(:,1),spec(:,2)/1000000);
grid on
xlim(1e3*[20,110])
xlabel('eV')
ylabel('cm^{-1}')

%%  interpolate the att coeff on the spectrum energy points

attinterp=interp1(cl3(:,1),cl3(:,2),spec(:,1),'linear');
figure(3);clf;
p(1)=loglog(cl3(:,1),cl3(:,2),'displayname','original chcl3');
hold on
p(2)=plot(spec(:,1),attinterp,'displayname','interpolated chcl3');
p(3)=plot(spec(:,1),spec(:,2)/1000000,'displayname','spectrum');
ylim([1e-2,1e4])
xlim([1e3,5e5])
grid on
title('interpolation check')
legend(p(1:3))
xlabel('eV')
ylabel('cm^{-1}')

%%
% create energy bins: half of forward bin plus half of backward bin
% at the edges, take full forward/backwrd bin
en=spec(:,1); % working copy of the energy values
bins=en(2:end)-en(1:end-1); % bin widths
bins=0.5*([0;bins]+[bins;0]); % half forward + half backward bin
bins(1)=bins(1)*2; % firt and last are special
bins(end)=bins(end)*2; 

% effective att coeff:
effatt=dot(bins.*spec(:,2),attinterp)/sum(bins.*spec(:,2))




