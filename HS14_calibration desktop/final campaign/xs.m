%% calculate the xray cross secition

function  [atttot,atttot_v]=xs
%first the data from spekcalc

% **** COMMENT ****
% 
% **** INPUTS ****
% kVp [kV] hvMIN [keV] Dhv [keV]
% 110  11  1
% Angle [deg.]
% 12
% t_AIR t_BE t_AL t_CU t_SN t_W t_Wa [mm]
% 1000  0  3.4  0.2  0  0  0
% Nf P
% 0.68  0.33
% ****CALCULATED OUTPUTS ****
% Brem[uGy/mAs@1m] Char[uGy/mAs@1m]
% 37.77275  4.150026
% HVL1[cm AL] HVL2[cm AL] HVL1[cmCu] HVL2[cmCu] MeanE[keV] EffEAl[keV] EffECu[keV]
% 0.7530923  0.9011965  0.0377079  0.0587936  61.55855  52.37369  54.62214
% **** CALCULATED SPECTRUM ****
% Energy[keV]  N[keV cm^2 mAs]^-1 @ 1 meter
if 1
spec= [11 , 4.235940e-15;
12 , 1.056486e-10 ;
13 , 2.567868e-7  ;
14 , 0.0000852    ;
15 , 0.0074988    ;
16 , 0.2509247    ;
17 , 3.885374     ;
18 , 34.772       ;
19 , 206.5956     ;
20 , 886.4131     ;
21 , 2924.845     ;
22 , 7997.122     ;
23 , 18415.28     ;
24 , 37476.11     ;
25 , 67421.13     ;
26 , 112373.8     ;
27 , 171939.6     ;
28 , 252642       ;
29 , 344636.6     ;
30 , 451831.1     ;
31 , 570758.7     ;
32 , 700179       ;
33 , 835063.7     ;
34 , 974990.4     ;
35 , 1.112241e+6  ;
36 , 1.246623e+6  ;
37 , 1.375792e+6  ;
38 , 1.500727e+6  ;
39 , 1.613081e+6  ;
40 , 1.720311e+6  ;
41 , 1.815014e+6  ;
42 , 1.902275e+6  ;
43 , 1.977505e+6  ;
44 , 2.045455e+6  ;
45 , 2.098338e+6  ;
46 , 2.146997e+6  ;
47 , 2.184832e+6  ;
48 , 2.214508e+6  ;
49 , 2.237069e+6  ;
50 , 2.250773e+6  ;
51 , 2.259073e+6  ;
52 , 2.256035e+6  ;
53 , 2.253790e+6  ;
54 , 2.244392e+6  ;
55 , 2.233469e+6  ;
56 , 2.212175e+6  ;
57 , 2.190791e+6  ;
58 , 6.109498e+6  ;
59 , 9.108508e+6  ;
60 , 2.110834e+6  ;
61 , 2.078199e+6  ;
62 , 2.043164e+6  ;
63 , 2.005841e+6  ;
64 , 1.971676e+6  ;
65 , 1.929713e+6  ;
66 , 1.891193e+6  ;
67 , 4.386712e+6  ;
68 , 1.808032e+6  ;
69 , 2.442177e+6  ;
70 , 1.522234e+6  ;
71 , 1.490227e+6  ;
72 , 1.459920e+6  ;
73 , 1.429941e+6  ;
74 , 1.397765e+6  ;
75 , 1.366144e+6  ;
76 , 1.331933e+6  ;
77 , 1.298882e+6  ;
78 , 1.265607e+6  ;
79 , 1.231013e+6  ;
80 , 1.196406e+6  ;
81 , 1.161623e+6  ;
82 , 1.127735e+6  ;
83 , 1.092687e+6  ;
84 , 1.056985e+6  ;
85 , 1.021636e+6  ;
86 , 987102.2     ;
87 , 951791.1     ;
88 , 917056.8     ;
89 , 881159.1     ;
90 , 846482.2     ;
91 , 810705.8     ;
92 , 775893.3     ;
93 , 740281.6     ;
94 , 704619.7     ;
95 , 669828.8     ;
96 , 633688.3     ;
97 , 598350.6     ;
98 , 561787.3     ;
99 , 526209       ;
100,  489580.9    ;
101,  453083.4    ;
102,  415478.2    ;
103,  377931.4    ;
104,  338111.9    ;
105,  296507.4    ;
106,  255760.7    ;
107,  214721.3    ;
108,  166169.4    ;
109,  81787.88    ;
110,  0           ];
end  % the spectrum goes here

if 1 % the xs data goes here
%     Photon    Tot. w/  
% Energy    Coherent 
% energy [MeV], CHCl3, H2O, Al, PvC, PVDC, PTFE[cm2/g]
Xs=[
1.100E-02, 3.905E+01, 4.026E+00, 1.981E+01, 2.546E+01, 3.236E+01, 5.128E+00; 
1.200E-02, 3.043E+01, 3.126E+00, 1.534E+01, 1.985E+01, 2.522E+01, 3.968E+00; 
1.300E-02, 2.417E+01, 2.487E+00, 1.212E+01, 1.577E+01, 2.003E+01, 3.142E+00; 
1.400E-02, 1.951E+01, 2.021E+00, 9.744E+00, 1.275E+01, 1.618E+01, 2.539E+00; 
1.500E-02, 1.598E+01, 1.672E+00, 7.955E+00, 1.045E+01, 1.326E+01, 2.088E+00; 
1.600E-02, 1.326E+01, 1.408E+00, 6.583E+00, 8.679E+00, 1.100E+01, 1.744E+00; 
1.700E-02, 1.112E+01, 1.203E+00, 5.513E+00, 7.291E+00, 9.234E+00, 1.478E+00; 
1.800E-02, 9.421E+00, 1.042E+00, 4.667E+00, 6.187E+00, 7.829E+00, 1.268E+00; 
1.900E-02, 8.055E+00, 9.134E-01, 3.990E+00, 5.300E+00, 6.698E+00, 1.102E+00; 
2.000E-02, 6.944E+00, 8.098E-01, 3.442E+00, 4.579E+00, 5.779E+00, 9.668E-01; 
2.100E-02, 6.031E+00, 7.253E-01, 2.993E+00, 3.986E+00, 5.023E+00, 8.569E-01; 
2.200E-02, 5.274E+00, 6.557E-01, 2.623E+00, 3.494E+00, 4.397E+00, 7.663E-01; 
2.300E-02, 4.642E+00, 5.978E-01, 2.314E+00, 3.084E+00, 3.874E+00, 6.910E-01; 
2.400E-02, 4.109E+00, 5.493E-01, 2.055E+00, 2.738E+00, 3.433E+00, 6.279E-01; 
2.500E-02, 3.657E+00, 5.082E-01, 1.836E+00, 2.445E+00, 3.059E+00, 5.745E-01; 
2.600E-02, 3.272E+00, 4.733E-01, 1.649E+00, 2.194E+00, 2.740E+00, 5.292E-01; 
2.700E-02, 2.941E+00, 4.433E-01, 1.489E+00, 1.979E+00, 2.466E+00, 4.903E-01; 
2.800E-02, 2.655E+00, 4.175E-01, 1.351E+00, 1.794E+00, 2.230E+00, 4.568E-01; 
2.900E-02, 2.407E+00, 3.951E-01, 1.232E+00, 1.632E+00, 2.024E+00, 4.278E-01; 
3.000E-02, 2.190E+00, 3.756E-01, 1.128E+00, 1.492E+00, 1.845E+00, 4.025E-01; 
3.100E-02, 2.001E+00, 3.584E-01, 1.037E+00, 1.369E+00, 1.689E+00, 3.803E-01; 
3.200E-02, 1.834E+00, 3.433E-01, 9.576E-01, 1.261E+00, 1.551E+00, 3.609E-01; 
3.300E-02, 1.687E+00, 3.300E-01, 8.873E-01, 1.165E+00, 1.429E+00, 3.436E-01; 
3.400E-02, 1.557E+00, 3.181E-01, 8.250E-01, 1.080E+00, 1.321E+00, 3.283E-01; 
3.500E-02, 1.441E+00, 3.075E-01, 7.696E-01, 1.005E+00, 1.225E+00, 3.147E-01; 
3.600E-02, 1.337E+00, 2.980E-01, 7.202E-01, 9.373E-01, 1.139E+00, 3.025E-01; 
3.700E-02, 1.244E+00, 2.894E-01, 6.760E-01, 8.770E-01, 1.062E+00, 2.916E-01; 
3.800E-02, 1.161E+00, 2.817E-01, 6.364E-01, 8.228E-01, 9.934E-01, 2.817E-01; 
3.900E-02, 1.086E+00, 2.747E-01, 6.007E-01, 7.740E-01, 9.314E-01, 2.728E-01; 
4.000E-02, 1.019E+00, 2.683E-01, 5.684E-01, 7.299E-01, 8.753E-01, 2.648E-01; 
4.100E-02, 9.574E-01, 2.625E-01, 5.392E-01, 6.900E-01, 8.246E-01, 2.574E-01; 
4.200E-02, 9.019E-01, 2.571E-01, 5.128E-01, 6.538E-01, 7.786E-01, 2.507E-01; 
4.300E-02, 8.514E-01, 2.523E-01, 4.886E-01, 6.208E-01, 7.367E-01, 2.446E-01; 
4.400E-02, 8.053E-01, 2.478E-01, 4.667E-01, 5.908E-01, 6.985E-01, 2.389E-01; 
4.500E-02, 7.632E-01, 2.436E-01, 4.466E-01, 5.633E-01, 6.636E-01, 2.338E-01; 
4.600E-02, 7.247E-01, 2.398E-01, 4.281E-01, 5.381E-01, 6.316E-01, 2.290E-01; 
4.700E-02, 6.893E-01, 2.362E-01, 4.112E-01, 5.149E-01, 6.023E-01, 2.246E-01; 
4.800E-02, 6.568E-01, 2.329E-01, 3.957E-01, 4.936E-01, 5.753E-01, 2.205E-01; 
4.900E-02, 6.269E-01, 2.298E-01, 3.814E-01, 4.740E-01, 5.505E-01, 2.167E-01; 
5.000E-02, 5.993E-01, 2.269E-01, 3.681E-01, 4.559E-01, 5.275E-01, 2.132E-01; 
5.100E-02, 5.738E-01, 2.242E-01, 3.559E-01, 4.392E-01, 5.063E-01, 2.099E-01; 
5.200E-02, 5.501E-01, 2.217E-01, 3.446E-01, 4.236E-01, 4.867E-01, 2.068E-01; 
5.300E-02, 5.282E-01, 2.193E-01, 3.340E-01, 4.092E-01, 4.685E-01, 2.039E-01; 
5.400E-02, 5.079E-01, 2.171E-01, 3.242E-01, 3.958E-01, 4.516E-01, 2.012E-01; 
5.500E-02, 4.890E-01, 2.149E-01, 3.151E-01, 3.834E-01, 4.358E-01, 1.987E-01; 
5.600E-02, 4.714E-01, 2.129E-01, 3.066E-01, 3.718E-01, 4.212E-01, 1.963E-01; 
5.700E-02, 4.550E-01, 2.110E-01, 2.987E-01, 3.609E-01, 4.075E-01, 1.940E-01; 
5.800E-02, 4.396E-01, 2.092E-01, 2.913E-01, 3.508E-01, 3.948E-01, 1.919E-01; 
5.900E-02, 4.253E-01, 2.075E-01, 2.843E-01, 3.413E-01, 3.828E-01, 1.899E-01; 
6.000E-02, 4.119E-01, 2.059E-01, 2.778E-01, 3.324E-01, 3.716E-01, 1.880E-01; 
6.100E-02, 3.993E-01, 2.043E-01, 2.717E-01, 3.241E-01, 3.612E-01, 1.862E-01; 
6.200E-02, 3.876E-01, 2.028E-01, 2.659E-01, 3.163E-01, 3.513E-01, 1.844E-01; 
6.300E-02, 3.765E-01, 2.014E-01, 2.605E-01, 3.089E-01, 3.421E-01, 1.828E-01; 
6.400E-02, 3.661E-01, 2.000E-01, 2.554E-01, 3.020E-01, 3.334E-01, 1.812E-01; 
6.500E-02, 3.563E-01, 1.987E-01, 2.506E-01, 2.954E-01, 3.252E-01, 1.797E-01; 
6.600E-02, 3.470E-01, 1.974E-01, 2.460E-01, 2.893E-01, 3.174E-01, 1.783E-01; 
6.700E-02, 3.383E-01, 1.962E-01, 2.417E-01, 2.834E-01, 3.102E-01, 1.769E-01; 
6.800E-02, 3.301E-01, 1.951E-01, 2.376E-01, 2.779E-01, 3.033E-01, 1.756E-01; 
6.900E-02, 3.223E-01, 1.939E-01, 2.338E-01, 2.727E-01, 2.967E-01, 1.744E-01; 
7.000E-02, 3.149E-01, 1.929E-01, 2.301E-01, 2.677E-01, 2.906E-01, 1.732E-01; 
7.100E-02, 3.080E-01, 1.918E-01, 2.266E-01, 2.630E-01, 2.847E-01, 1.720E-01; 
7.200E-02, 3.014E-01, 1.908E-01, 2.233E-01, 2.586E-01, 2.792E-01, 1.709E-01; 
7.300E-02, 2.951E-01, 1.898E-01, 2.202E-01, 2.543E-01, 2.739E-01, 1.698E-01; 
7.400E-02, 2.891E-01, 1.888E-01, 2.172E-01, 2.503E-01, 2.689E-01, 1.688E-01; 
7.500E-02, 2.835E-01, 1.879E-01, 2.143E-01, 2.465E-01, 2.642E-01, 1.678E-01; 
7.600E-02, 2.781E-01, 1.870E-01, 2.116E-01, 2.428E-01, 2.596E-01, 1.668E-01; 
7.700E-02, 2.730E-01, 1.861E-01, 2.089E-01, 2.393E-01, 2.553E-01, 1.659E-01; 
7.800E-02, 2.681E-01, 1.853E-01, 2.064E-01, 2.360E-01, 2.512E-01, 1.650E-01; 
7.900E-02, 2.635E-01, 1.845E-01, 2.041E-01, 2.328E-01, 2.473E-01, 1.641E-01; 
8.000E-02, 2.590E-01, 1.837E-01, 2.018E-01, 2.298E-01, 2.435E-01, 1.632E-01; 
8.100E-02, 2.548E-01, 1.829E-01, 1.996E-01, 2.269E-01, 2.399E-01, 1.624E-01; 
8.200E-02, 2.507E-01, 1.821E-01, 1.975E-01, 2.241E-01, 2.365E-01, 1.616E-01; 
8.300E-02, 2.469E-01, 1.814E-01, 1.955E-01, 2.214E-01, 2.332E-01, 1.608E-01; 
8.400E-02, 2.431E-01, 1.806E-01, 1.935E-01, 2.188E-01, 2.301E-01, 1.601E-01; 
8.500E-02, 2.396E-01, 1.799E-01, 1.917E-01, 2.164E-01, 2.271E-01, 1.593E-01; 
8.600E-02, 2.362E-01, 1.792E-01, 1.899E-01, 2.140E-01, 2.242E-01, 1.586E-01; 
8.700E-02, 2.329E-01, 1.785E-01, 1.881E-01, 2.118E-01, 2.214E-01, 1.579E-01; 
8.800E-02, 2.298E-01, 1.779E-01, 1.865E-01, 2.096E-01, 2.188E-01, 1.572E-01; 
8.900E-02, 2.268E-01, 1.772E-01, 1.849E-01, 2.075E-01, 2.162E-01, 1.565E-01; 
9.000E-02, 2.239E-01, 1.766E-01, 1.833E-01, 2.054E-01, 2.137E-01, 1.559E-01; 
9.100E-02, 2.211E-01, 1.759E-01, 1.818E-01, 2.035E-01, 2.114E-01, 1.552E-01; 
9.200E-02, 2.185E-01, 1.753E-01, 1.804E-01, 2.016E-01, 2.091E-01, 1.546E-01; 
9.300E-02, 2.159E-01, 1.747E-01, 1.790E-01, 1.998E-01, 2.069E-01, 1.540E-01; 
9.400E-02, 2.134E-01, 1.741E-01, 1.777E-01, 1.981E-01, 2.048E-01, 1.534E-01; 
9.500E-02, 2.111E-01, 1.735E-01, 1.764E-01, 1.964E-01, 2.028E-01, 1.528E-01; 
9.600E-02, 2.088E-01, 1.729E-01, 1.751E-01, 1.947E-01, 2.008E-01, 1.522E-01; 
9.700E-02, 2.066E-01, 1.724E-01, 1.739E-01, 1.932E-01, 1.989E-01, 1.517E-01; 
9.800E-02, 2.044E-01, 1.718E-01, 1.727E-01, 1.916E-01, 1.971E-01, 1.511E-01; 
9.900E-02, 2.024E-01, 1.713E-01, 1.715E-01, 1.901E-01, 1.953E-01, 1.506E-01; 
1.000E-01, 2.004E-01, 1.707E-01, 1.704E-01, 1.887E-01, 1.936E-01, 1.500E-01; 
1.010E-01, 1.984E-01, 1.702E-01, 1.693E-01, 1.873E-01, 1.919E-01, 1.495E-01; 
1.020E-01, 1.966E-01, 1.697E-01, 1.683E-01, 1.860E-01, 1.903E-01, 1.490E-01; 
1.030E-01, 1.948E-01, 1.692E-01, 1.673E-01, 1.847E-01, 1.888E-01, 1.485E-01; 
1.040E-01, 1.930E-01, 1.686E-01, 1.663E-01, 1.834E-01, 1.872E-01, 1.480E-01; 
1.050E-01, 1.914E-01, 1.681E-01, 1.653E-01, 1.822E-01, 1.858E-01, 1.475E-01; 
1.060E-01, 1.897E-01, 1.677E-01, 1.644E-01, 1.810E-01, 1.844E-01, 1.470E-01; 
1.070E-01, 1.881E-01, 1.672E-01, 1.634E-01, 1.798E-01, 1.830E-01, 1.466E-01; 
1.080E-01, 1.866E-01, 1.667E-01, 1.625E-01, 1.787E-01, 1.817E-01, 1.461E-01; 
1.090E-01, 1.851E-01, 1.662E-01, 1.617E-01, 1.776E-01, 1.804E-01, 1.456E-01; 
1.100E-01, 1.837E-01, 1.657E-01, 1.608E-01, 1.765E-01, 1.791E-01, 1.452E-01;];
end
len=size(Xs,2);

% densities here
%      chcl3    h2o    alu  pvc  PVDC  PTFE 
rho_l=[1.411, 0.9555, 2.70, 1.3, 1.63, 2.2]; %g/cm3, water: 2bar/ 104 °C
rho_v=4.475/1000; % kg/m3 into g/cm3 chloroform

en=spec(:,1); % energy
sp=spec(:,2)/sum(spec(:,2)); %normalized spectrum

att_nams={'ChCl3','H2O','Al','PvC','PVDC','PTFE'};
att=Xs(:,2:len).*repmat(rho_l,[100,1]);% xs*density

% energy weighted effective attenuation coefficient
atttot=sum(att.*repmat(sp,[1,len-1]),1)/sum(sp);

% special case for chloro vapor
atttot_v=atttot(1)/rho_l(1)*rho_v;


h=figure(400);clf;
ax=gca();
hold on
col=hsv(len-1);
% col=[1,0,0;
%     0 0 1;
%     0 0.5 0;
%     1 0.3 1];
    
for i = 1:len-1
    
    loglog(en,att(:,i),'displayname',att_nams{i},'color',col(i,:));
    loglog([11,110],atttot(i)*[1,1],'--','color',col(i,:),...
        'displayname',strcat(att_nams{i},' eff'));
end
yfac=1.25;
text(15,1/yfac*atttot(1),sprintf('%.2f',atttot(1)),'color',col(1,:))
text(20,yfac*atttot(2),sprintf('%.2f',atttot(2)),'color',col(2,:))
text(20,yfac*atttot(3),sprintf('%.2f',atttot(3)),'color',col(3,:))
text(12,yfac*atttot(4),sprintf('%.2f',atttot(3)),'color',col(4,:))


loglog(en,100*sp,'k','displayname','110kV @LKE')
set(gca, 'YScale', 'log')
set(gca, 'XScale', 'log')
legend('location','best')
title('attenuation coefficients')
grid on
xlabel('energy [keV]')
ylabel('attenuation coefficient [1/cm]')
xlim([10,150])
ylim([0.1,100])


fname='Fig400 attenuation coefficients xray';
% f.f_BoFig2PDF(h,fname)
% 
% h2=figure(402);
% ax=cla;
% hold on
% for i = 1:len-1
%     
%     loglog(en,att(:,i)/att(20,i),'displayname',att_nams{i},'color',col(i,:));
% 
% end
% loglog(en,100*sp,'k','displayname','normalized spectrum')
% set(gca, 'YScale', 'log')
% set(gca, 'XScale', 'log')
% legend('location','best')
% title('relative attenuation coefficients')
% grid on
% xlabel('energy [keV]')
% ylabel('attenuation coefficient, normalized at 20keV')
% xlim([10,150])
% ylim([0.1,100])
% 
% end

